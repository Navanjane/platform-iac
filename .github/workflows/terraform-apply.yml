name: Terraform Apply

on:
  push:
    branches:
      - develop
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches:
      - main
      - develop
  workflow_dispatch:  # Manual trigger

env:
  AWS_REGION: us-east-1
  TF_VERSION: 1.14.3
  TF_VAR_use_iam_role: false  # GitHub Actions already assumed the role

jobs:
  terraform-plan:
    name: Terraform Validate
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: github.event.action != 'closed'
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_TERRAFORM_ROLE_ARN }}
          role-duration-seconds: 7200
          role-skip-session-tagging: true

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Init
        id: init
        run: terraform init

      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color

      - name: Comment PR with Plan
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        env:
          PLAN: "${{ steps.plan.outputs.stdout }}"
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `#### Terraform Format and Style ðŸ–Œ\`${{ steps.fmt.outcome }}\`
            #### Terraform Initialization âš™ï¸\`${{ steps.init.outcome }}\`
            #### Terraform Validation ðŸ¤–\`${{ steps.validate.outcome }}\`

            *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })


  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    timeout-minutes: 90
    # IMPORTANT: Never run terraform apply on push events (only on PR merge to main or manual trigger)
    if: |
      github.event_name != 'push' &&
      (github.event_name == 'workflow_dispatch' ||
       (github.event_name == 'pull_request' &&
        github.event.action == 'closed' &&
        github.event.pull_request.merged == true &&
        github.event.pull_request.base.ref == 'main'))
    environment:
      name: development
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_TERRAFORM_ROLE_ARN }}
          role-duration-seconds: 7200
          role-skip-session-tagging: true

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: terraform init

      - name: Apply Module - IAM
        run: |
          echo "ðŸ“¦ Applying IAM module..."
          terraform apply -target=module.iam -auto-approve -input=false || echo "âš ï¸ IAM resources may already exist, continuing..."
        continue-on-error: true

      - name: Apply Module - VPC
        run: |
          echo "ðŸ“¦ Applying VPC module..."
          terraform apply -target=module.vpc -auto-approve -input=false

      - name: Apply Module - EKS Cluster
        run: |
          echo "ðŸ“¦ Applying EKS cluster..."
          terraform apply -target=module.eks.module.eks.aws_eks_cluster.this -auto-approve -input=false

      - name: Apply Module - EKS Supporting Resources
        run: |
          echo "ðŸ“¦ Applying EKS supporting resources (security groups, IAM, KMS)..."
          terraform apply -target=module.eks.module.eks -auto-approve -input=false

      - name: Apply All Remaining Resources
        run: |
          echo "ðŸ“¦ Applying all remaining resources (node groups, addons)..."
          terraform apply -auto-approve -input=false
        continue-on-error: true

      - name: Verify Deployment
        if: success()
        run: |
          echo "âœ… Terraform apply completed successfully"
          echo ""
          echo "ðŸ“Š Deployment Summary:"
          terraform output -json | jq -r 'to_entries[] | "  \(.key): \(.value.value)"'

      - name: Notify on Failure
        if: failure()
        run: echo "âŒ Terraform apply failed"

  generate-kubeconfig:
    name: Generate Kubeconfig
    runs-on: ubuntu-latest
    needs: terraform-apply
    timeout-minutes: 10
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_TERRAFORM_ROLE_ARN }}
          role-duration-seconds: 3600
          role-skip-session-tagging: true

      - name: Generate Kubeconfig
        run: |
          echo "ðŸ“ Generating kubeconfig for EKS cluster..."
          aws eks update-kubeconfig \
            --region ${{ env.AWS_REGION }} \
            --name platform-eks-dev \
            --kubeconfig ./kubeconfig-platform-eks-dev
          echo "âœ… Kubeconfig generated successfully"
          
      - name: Verify Kubeconfig
        run: |
          echo "ðŸ” Verifying kubeconfig..."
          export KUBECONFIG=./kubeconfig-platform-eks-dev
          kubectl version --client
          kubectl cluster-info
          
      - name: Upload Kubeconfig as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: kubeconfig-platform-eks-dev
          path: ./kubeconfig-platform-eks-dev
          retention-days: 7
          
      - name: Kubeconfig Summary
        run: |
          echo "âœ… Kubeconfig generation completed"
          echo ""
          echo "ðŸ“¥ Download Instructions:"
          echo "  1. Go to Actions tab -> This workflow run"
          echo "  2. Scroll to Artifacts section"
          echo "  3. Download 'kubeconfig-platform-eks-dev'"
          echo "  4. Use: export KUBECONFIG=./kubeconfig-platform-eks-dev"
