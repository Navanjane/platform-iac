name: Terraform Apply

on:
  push:
    branches:
      - develop
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches:
      - main
      - develop
  workflow_dispatch:  # Manual trigger

env:
  AWS_REGION: us-east-1
  TF_VERSION: 1.14.3
  TF_VAR_use_iam_role: false  # GitHub Actions already assumed the role

jobs:
  terraform-plan:
    name: Terraform Validate
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: github.event.action != 'closed' || (github.event.action == 'closed' && github.event.pull_request.merged == true)
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_TERRAFORM_ROLE_ARN }}
          role-duration-seconds: 7200
          role-skip-session-tagging: true

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Init
        id: init
        run: terraform init

      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color

      - name: Comment PR with Plan
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        env:
          PLAN: "${{ steps.plan.outputs.stdout }}"
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `#### Terraform Format and Style üñå\`${{ steps.fmt.outcome }}\`
            #### Terraform Initialization ‚öôÔ∏è\`${{ steps.init.outcome }}\`
            #### Terraform Validation ü§ñ\`${{ steps.validate.outcome }}\`

            *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

  terraform-init:
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main')
    name: Initialize Terraform
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: terraform-plan
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_TERRAFORM_ROLE_ARN }}
          role-duration-seconds: 7200
          role-skip-session-tagging: true

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: terraform init

  apply-iam:
    name: Apply IAM Module
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: terraform-init
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_TERRAFORM_ROLE_ARN }}
          role-duration-seconds: 7200
          role-skip-session-tagging: true

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: terraform init

      - name: Apply IAM Module
        run: |
          echo "üì¶ Applying IAM module..."
          terraform apply -target=module.iam -auto-approve -input=false || echo "‚ö†Ô∏è IAM resources may already exist, continuing..."
        continue-on-error: true

  apply-vpc:
    name: Apply VPC Module
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: apply-iam
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_TERRAFORM_ROLE_ARN }}
          role-duration-seconds: 7200
          role-skip-session-tagging: true

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: terraform init

      - name: Apply VPC Module
        run: |
          echo "üì¶ Applying VPC module..."
          terraform apply -target=module.vpc -auto-approve -input=false

  apply-eks:
    name: Apply EKS Module
    runs-on: ubuntu-latest
    timeout-minutes: 60
    needs: apply-vpc
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_TERRAFORM_ROLE_ARN }}
          role-duration-seconds: 7200
          role-skip-session-tagging: true

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: terraform init

      - name: Apply EKS Cluster
        run: |
          echo "üì¶ Applying EKS cluster..."
          terraform apply -target=module.eks.module.eks.aws_eks_cluster.this -auto-approve -input=false

      - name: Apply EKS Supporting Resources
        run: |
          echo "üì¶ Applying EKS supporting resources (security groups, IAM, KMS)..."
          terraform apply -target=module.eks.module.eks -auto-approve -input=false

      - name: Apply All Remaining Resources
        run: |
          echo "üì¶ Applying all remaining resources (node groups, addons)..."
          terraform apply -auto-approve -input=false
        continue-on-error: true

      - name: Verify Deployment
        if: success()
        run: |
          echo "‚úÖ EKS deployment completed successfully"
          echo ""
          echo "üìä Deployment Summary:"
          terraform output -json | jq -r 'to_entries[] | "  \(.key): \(.value.value)"'

  generate-kubeconfig:
    name: Generate Kubeconfig
    runs-on: ubuntu-latest
    needs: apply-eks
    timeout-minutes: 10
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_TERRAFORM_ROLE_ARN }}
          role-duration-seconds: 3600
          role-skip-session-tagging: true

      - name: Generate Kubeconfig
        run: |
          echo "üìù Generating kubeconfig for EKS cluster..."
          aws eks update-kubeconfig \
            --region ${{ env.AWS_REGION }} \
            --name platform-eks-dev \
            --kubeconfig ./kubeconfig-platform-eks-dev
          echo "‚úÖ Kubeconfig generated successfully"
          
      - name: Verify Kubeconfig
        run: |
          echo "üîç Verifying kubeconfig..."
          export KUBECONFIG=./kubeconfig-platform-eks-dev
          kubectl version --client
          kubectl cluster-info
          
      - name: Upload Kubeconfig as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: kubeconfig-platform-eks-dev
          path: ./kubeconfig-platform-eks-dev
          retention-days: 7
          
      - name: Kubeconfig Summary
        run: |
          echo "‚úÖ Kubeconfig generation completed"
          echo ""
          echo "üì• Download Instructions:"
          echo "  1. Go to Actions tab -> This workflow run"
          echo "  2. Scroll to Artifacts section"
          echo "  3. Download 'kubeconfig-platform-eks-dev'"
          echo "  4. Use: export KUBECONFIG=./kubeconfig-platform-eks-dev"


  verify-cluster:
    name: Verify Kubernetes Cluster
    runs-on: ubuntu-latest
    needs: generate-kubeconfig
    timeout-minutes: 10
    permissions:
      contents: read
    
    steps:
      - name: Download Kubeconfig Artifact
        uses: actions/download-artifact@v4
        with:
          name: kubeconfig-platform-eks-dev
          path: .

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_TERRAFORM_ROLE_ARN }}
          role-duration-seconds: 3600
          role-skip-session-tagging: true
          
      - name: Configure kubectl
        run: |
          echo "üîß Configuring kubectl..."
          export KUBECONFIG=./kubeconfig-platform-eks-dev
          kubectl version --client
          echo "‚úÖ kubectl configured successfully"
          
      - name: Verify Cluster Connection
        run: |
          echo "üîç Verifying cluster connection..."
          export KUBECONFIG=./kubeconfig-platform-eks-dev
          kubectl cluster-info
          kubectl get nodes -o wide
          
      - name: List All Pods
        run: |
          echo "üì¶ Listing all pods in all namespaces..."
          export KUBECONFIG=./kubeconfig-platform-eks-dev
          kubectl get pods --all-namespaces -o wide
          
      - name: List System Components
        run: |
          echo "üîß Checking system components..."
          export KUBECONFIG=./kubeconfig-platform-eks-dev
          echo ""
          echo "=== Namespaces ==="
          kubectl get namespaces
          echo ""
          echo "=== Deployments in kube-system ==="
          kubectl get deployments -n kube-system
          echo ""
          echo "=== DaemonSets in kube-system ==="
          kubectl get daemonsets -n kube-system
          
      - name: Cluster Health Summary
        run: |
          echo "‚úÖ Kubernetes cluster verification completed"
          echo ""
          export KUBECONFIG=./kubeconfig-platform-eks-dev
          echo "üìä Cluster Summary:"
          echo "  Nodes: $(kubectl get nodes --no-headers | wc -l)"
          echo "  Pods: $(kubectl get pods --all-namespaces --no-headers | wc -l)"
          echo "  Namespaces: $(kubectl get namespaces --no-headers | wc -l)"
